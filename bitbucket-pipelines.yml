image: node:18

pipelines:
  branches:
    main:
      - step:
          name: Build Frontend
          script:
            - cd frontend
            - npm ci
            - npm run build
          artifacts:
            - frontend/dist/**
      - step:
          name: Deploy to Bitbucket Pages
          trigger: manual
          script:
            - apt-get update && apt-get install -y git
            - git config --global user.email "bitbucket-pipelines@example.com"
            - git config --global user.name "Bitbucket Pipelines"
            - |
              # Clone the gh-pages branch (or create it if it doesn't exist)
              git clone --depth 1 -b gh-pages "https://x-token-auth:${BB_AUTH_TOKEN}@bitbucket.org/${BITBUCKET_REPO_FULL_SLUG}.git" gh-pages 2>/dev/null || \
              git clone --depth 1 "https://x-token-auth:${BB_AUTH_TOKEN}@bitbucket.org/${BITBUCKET_REPO_FULL_SLUG}.git" gh-pages && \
              cd gh-pages && git checkout --orphan gh-pages && git rm -rf .
            - |
              # Copy the build output to gh-pages
              cp -r ../frontend/dist/* .
              git add .
              git commit -m "Deploy from Bitbucket Pipelines: ${BITBUCKET_COMMIT}" || true
              git push -u origin gh-pages
          after-script:
            - echo "âœ“ Deployed to Bitbucket Pages"

definitions:
  caches:
    npm: ~/.npm
